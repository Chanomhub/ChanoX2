name: Update Flathub

# This workflow runs after a release is published.
# It requires FLATHUB_TOKEN secret - a GitHub Personal Access Token with 'repo' scope
# that has write access to flathub/com.chanomhub.chanox2
#
# To get write access:
# 1. First, submit initial PR to flathub/flathub manually
# 2. After approval, Flathub creates repo and invites you as collaborator
# 3. Create PAT: GitHub Settings → Developer settings → Personal access tokens → Generate new token
# 4. Select 'repo' scope
# 5. Add as secret: Your repo → Settings → Secrets → FLATHUB_TOKEN

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to update (e.g., 1.4.1)'
        required: true

permissions:
  contents: read

jobs:
  update-flathub:
    runs-on: ubuntu-latest
    if: ${{ !github.event.release.prerelease }}
    
    steps:
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION="${{ github.event.release.tag_name }}"
          else
            VERSION="v${{ github.event.inputs.version }}"
          fi
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"

      - name: Download tar.gz from release
        run: |
          wget -q "https://github.com/${{ github.repository }}/releases/download/v${{ steps.version.outputs.version }}/ChanoX2-${{ steps.version.outputs.version }}.tar.gz" -O chanox2.tar.gz
          
      - name: Calculate SHA256
        id: sha256
        run: |
          SHA256=$(sha256sum chanox2.tar.gz | cut -d' ' -f1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"

      - name: Download icon SHA256
        id: icon_sha256
        run: |
          wget -q "https://raw.githubusercontent.com/${{ github.repository }}/main/public/icon.png" -O icon.png
          SHA256=$(sha256sum icon.png | cut -d' ' -f1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "Icon SHA256: $SHA256"

      - name: Clone Flathub repo
        env:
          FLATHUB_TOKEN: ${{ secrets.FLATHUB_TOKEN }}
        run: |
          git clone "https://x-access-token:${FLATHUB_TOKEN}@github.com/flathub/com.chanomhub.chanox2.git" flathub-repo

      - name: Update manifest
        working-directory: flathub-repo
        run: |
          # Update version in tar.gz URL
          sed -i "s|/releases/download/v[^/]*/ChanoX2-[^.]*\.tar\.gz|/releases/download/v${{ steps.version.outputs.version }}/ChanoX2-${{ steps.version.outputs.version }}.tar.gz|g" com.chanomhub.chanox2.yml
          
          # Update first SHA256 (tar.gz)
          sed -i "0,/sha256: [a-f0-9]\{64\}/s//sha256: ${{ steps.sha256.outputs.sha256 }}/" com.chanomhub.chanox2.yml

      - name: Update metainfo release
        working-directory: flathub-repo
        run: |
          DATE=$(date +%Y-%m-%d)
          # Add new release entry if not exists
          if ! grep -q "version=\"${{ steps.version.outputs.version }}\"" com.chanomhub.chanox2.metainfo.xml; then
            sed -i "s|<releases>|<releases>\n    <release version=\"${{ steps.version.outputs.version }}\" date=\"$DATE\">\n      <description>\n        <p>See release notes on GitHub</p>\n      </description>\n    </release>|" com.chanomhub.chanox2.metainfo.xml
          fi

      - name: Push update
        working-directory: flathub-repo
        env:
          FLATHUB_TOKEN: ${{ secrets.FLATHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add -A
          if git diff --staged --quiet; then
            echo "No changes to commit"
            exit 0
          fi
          
          git commit -m "Update to version ${{ steps.version.outputs.version }}"
          git push
